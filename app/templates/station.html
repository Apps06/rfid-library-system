{% extends 'base.html' %}

{% block title %}Check-in Station - Library Logger{% endblock %}
{% block page_title %}Zone Selection Station{% endblock %}

{% block content %}
<div id="station-container" class="text-center" style="max-width: 800px; margin: 40px auto;">
    
    <!-- Waiting State -->
    <div id="waiting-card" class="card">
        <div class="empty-state">
            <div class="empty-state-icon" id="scan-icon">üì°</div>
            <div class="empty-state-title">Ready for Scanning</div>
            <p>Please scan your RFID card at the reader to continue</p>
        </div>
        
        <div class="mt-3" style="padding: 20px; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px dashed var(--border-color);">
            <small class="text-muted">The station will automatically detect your card once scanned.</small>
        </div>
    </div>

    <!-- Active Selection State (Hidden by default) -->
    <div id="selection-card" class="card" style="display: none; animation: scaleIn 0.3s ease;">
        <div class="card-header text-center" style="display: block;">
            <div id="student-avatar" style="font-size: 64px; margin-bottom: 16px;">üë§</div>
            <h2 id="student-name" style="font-size: 28px; margin-bottom: 4px;">Student Name</h2>
            <div id="student-roll" class="text-muted" style="font-size: 18px;">ROLL_NUMBER</div>
        </div>

        <div class="mt-3">
            <h3 style="margin-bottom: 24px; color: var(--text-secondary);">Select your destination:</h3>
            
            <div class="grid-3" style="gap: 20px;">
                <button class="zone-btn" onclick="selectZone('Library')">
                    <span class="zone-icon">üìö</span>
                    <span class="zone-label">Library</span>
                </button>
                <button class="zone-btn" onclick="selectZone('Lab')">
                    <span class="zone-icon">üî¨</span>
                    <span class="zone-label">Labs</span>
                </button>
                <button class="zone-btn" onclick="selectZone('Classroom')">
                    <span class="zone-icon">üè´</span>
                    <span class="zone-label">Classrooms</span>
                </button>
            </div>
        </div>

        <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
            <button class="btn btn-secondary" onclick="resetStation()">Cancel / Reset</button>
        </div>
    </div>

    <!-- Success Feedback (Hidden) -->
    <div id="success-card" class="card" style="display: none; animation: fadeIn 0.3s ease;">
        <div class="empty-state">
            <div class="empty-state-icon" style="color: var(--success); opacity: 1;">‚úÖ</div>
            <div class="empty-state-title" id="success-title">Log Updated!</div>
            <p id="success-message">Your attendance has been recorded for the Library.</p>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="resetStation()">OK, Next Student</button>
            </div>
        </div>
    </div>
</div>

<style>
.zone-btn {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 30px 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    color: var(--text-primary);
}

.zone-btn:hover {
    transform: translateY(-8px);
    border-color: var(--accent-primary);
    background: var(--bg-hover);
    box-shadow: var(--shadow-lg);
}

.zone-icon {
    font-size: 48px;
}

.zone-label {
    font-size: 18px;
    font-weight: 700;
}

@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#scan-icon {
    animation: pulse 2s infinite;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let lastProcessedTime = null;
let currentLogId = null;
let pollingInterval = null;

const waitingCard = document.getElementById('waiting-card');
const selectionCard = document.getElementById('selection-card');
const successCard = document.getElementById('success-card');
const studentName = document.getElementById('student-name');
const studentRoll = document.getElementById('student-roll');

// Start polling for scans
function startPolling() {
    pollingInterval = setInterval(async () => {
        try {
            const response = await API.get('/attendance?per_page=1');
            if (response && response.success && response.logs.length > 0) {
                const latest = response.logs[0];
                const logTime = new Date(latest.timestamp).getTime();
                const now = new Date().getTime();
                
                // If scan happened in last 5 seconds and is newer than our last check
                if (now - logTime < 5000 && (!lastProcessedTime || logTime > lastProcessedTime)) {
                    lastProcessedTime = logTime;
                    showSelection(latest);
                }
            }
        } catch (e) {
            console.error("Polling error", e);
        }
    }, 1000);
}

function showSelection(log) {
    clearInterval(pollingInterval);
    currentLogId = log.id;
    
    studentName.textContent = log.student_name || `New Card: ${log.rfid_uid}`;
    studentRoll.textContent = log.roll_number || 'Temporary Record';
    
    waitingCard.style.display = 'none';
    selectionCard.style.display = 'block';
    successCard.style.display = 'none';
    
    showToast('Identify!', 'Please select your destination', 'info');
}

async function selectZone(zone) {
    if (!currentLogId) return;
    
    const result = await API.put(`/attendance/${currentLogId}/zone`, { zone: zone });
    
    if (result && result.success) {
        document.getElementById('success-message').textContent = `Your attendance has been recorded for the ${zone}.`;
        
        selectionCard.style.display = 'none';
        successCard.style.display = 'block';
        
        showToast('Success', `Destination set to ${zone}`, 'success');
        
        // Auto reset after 3 seconds
        setTimeout(resetStation, 3000);
    } else {
        showToast('Error', 'Failed to update zone', 'error');
    }
}

function resetStation() {
    waitingCard.style.display = 'block';
    selectionCard.style.display = 'none';
    successCard.style.display = 'none';
    currentLogId = null;
    startPolling();
}

// Initial start
startPolling();
</script>
{% endblock %}
