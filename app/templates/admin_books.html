{% extends 'base.html' %}

{% block title %}Manage Books - Library Logger{% endblock %}
{% block page_title %}ðŸ“š Manage Book Catalog{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 class="card-title">Catalog</h2>
        <button class="btn btn-primary" onclick="showAddBookModal()">+ Add New Book</button>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>ISBN</th>
                    <th>Available / Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="books-table-body">
                <!-- Books will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Book Modal -->
<div id="book-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <h2 id="modal-title">Add New Book</h2>
        <form id="book-form" onsubmit="saveBook(event)" style="margin-top: 20px;">
            <input type="hidden" id="edit-book-id">
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" id="modal-title-input" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Author</label>
                <input type="text" id="modal-author-input" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">ISBN</label>
                <input type="text" id="modal-isbn-input" class="form-input">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">Total Copies</label>
                    <input type="number" id="modal-copies-input" class="form-input" value="1" min="1" required>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-top: 24px;">
                    <input type="checkbox" id="modal-important-input">
                    <label class="form-label" style="margin: 0;">Mark as Important</label>
                </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeBookModal()" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 2;">Save Book</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.modal-content {
    background: var(--card-bg);
    padding: 32px;
    border-radius: var(--radius-lg);
    width: 90%;
}
</style>
{% endblock %}

{% block scripts %}
<script>
async function loadBooks() {
    const response = await API.get('/books');
    if (response && response.success) {
        const tbody = document.getElementById('books-table-body');
        tbody.innerHTML = response.books.map(book => `
            <tr>
                <td><strong>${book.title}</strong></td>
                <td>${book.author || '-'}</td>
                <td><code>${book.isbn || '-'}</code></td>
                <td>${book.available_copies} / ${book.total_copies}</td>
                <td>
                    ${book.is_important ? '<span class="badge badge-warning">Important</span>' : '<span class="badge badge-success">Standard</span>'}
                </td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" onclick="editBook(${JSON.stringify(book).replace(/"/g, '&quot;')})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">Del</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
}

function showAddBookModal() {
    document.getElementById('modal-title').textContent = 'Add New Book';
    document.getElementById('edit-book-id').value = '';
    document.getElementById('book-form').reset();
    document.getElementById('book-modal').style.display = 'flex';
}

function editBook(book) {
    document.getElementById('modal-title').textContent = 'Edit Book';
    document.getElementById('edit-book-id').value = book.id;
    document.getElementById('modal-title-input').value = book.title;
    document.getElementById('modal-author-input').value = book.author;
    document.getElementById('modal-isbn-input').value = book.isbn;
    document.getElementById('modal-copies-input').value = book.total_copies;
    document.getElementById('modal-important-input').checked = book.is_important;
    document.getElementById('book-modal').style.display = 'flex';
}

function closeBookModal() {
    document.getElementById('book-modal').style.display = 'none';
}

async function saveBook(e) {
    e.preventDefault();
    const id = document.getElementById('edit-book-id').value;
    const data = {
        title: document.getElementById('modal-title-input').value,
        author: document.getElementById('modal-author-input').value,
        isbn: document.getElementById('modal-isbn-input').value,
        total_copies: parseInt(document.getElementById('modal-copies-input').value),
        is_important: document.getElementById('modal-important-input').checked
    };

    let result;
    if (id) {
        result = await API.put(`/books/${id}`, data);
    } else {
        result = await API.post('/books', data);
    }

    if (result.success) {
        showToast('Success', 'Book saved successfully', 'success');
        closeBookModal();
        loadBooks();
    } else {
        showToast('Error', result.error || 'Failed to save book', 'error');
    }
}

async function deleteBook(id) {
    if (!confirm('Are you sure you want to delete this book?')) return;
    const result = await API.delete(`/books/${id}`);
    if (result.success) {
        showToast('Deleted', 'Book removed from catalog', 'success');
        loadBooks();
    }
}

document.addEventListener('DOMContentLoaded', loadBooks);
</script>
{% endblock %}
